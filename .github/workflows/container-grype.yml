name: Build, Scan (Grype) and Push - Backend

on:
  push:
    branches: [ "main", "development" ]
  pull_request:
    branches: [ "main", "development" ]
  workflow_dispatch:

jobs:
  build_scan_push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    env:
      DOCKERHUB_REPO: unachat/unachat
      IMAGE: unachat/unachat:development

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build development image
        run: |
          docker build -t $IMAGE .
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          docker tag $IMAGE $DOCKERHUB_REPO:sha-$SHORT_SHA

      - name: Docker login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Verify Docker Hub authentication
        run: |
          echo "Verifying Docker Hub login..."
          docker info | grep Username || echo "Warning: Not logged in to Docker Hub"
          echo "Testing repository access..."
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/unachat:development 2>/dev/null || echo "Repository may not exist yet or is not accessible"

      - name: Debug - Show built image
        run: |
          echo "Built images:"
          docker images --format 'table {{.Repository}}\t{{.Tag}}\t{{.ID}}\t{{.Size}}'
          echo "Inspecting target image:"
          docker image inspect $IMAGE || true

      - name: Install Grype
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh \
            | sh -s -- -b /usr/local/bin

      - name: Grype table (non-blocking)
        run: |
          grype $IMAGE -o table || true

      - name: Grype SARIF (non-blocking)
        run: |
          grype $IMAGE -o sarif > grype.sarif || true

      - name: Upload SARIF to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: grype.sarif

      - name: Grype severity gate (fail on CRITICAL)
        run: |
          grype $IMAGE --fail-on critical -o json > /dev/null

      - name: Push image (development and sha)
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          echo "Pushing images to Docker Hub..."
          echo "Image 1: $IMAGE"
          echo "Image 2: $DOCKERHUB_REPO:sha-$SHORT_SHA"
          
          # Push development tag
          if docker push $IMAGE; then
            echo "✅ Successfully pushed $IMAGE"
          else
            echo "❌ Failed to push $IMAGE"
            echo "Please verify:"
            echo "1. Docker Hub repository exists: https://hub.docker.com/r/$DOCKERHUB_REPO"
            echo "2. DOCKERHUB_USERNAME matches the repository owner"
            echo "3. DOCKERHUB_TOKEN has write permissions"
            exit 1
          fi
          
          # Push SHA tag
          if docker push $DOCKERHUB_REPO:sha-$SHORT_SHA; then
            echo "✅ Successfully pushed $DOCKERHUB_REPO:sha-$SHORT_SHA"
          else
            echo "❌ Failed to push $DOCKERHUB_REPO:sha-$SHORT_SHA"
            exit 1
          fi
