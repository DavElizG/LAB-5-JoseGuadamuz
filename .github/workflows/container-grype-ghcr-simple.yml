name: Build and Scan (Grype) - GHCR Simple

on:
  push:
    branches: [ "main", "development" ]
  pull_request:
    branches: [ "main", "development" ]
  workflow_dispatch:

jobs:
  build_scan_push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      security-events: write

    env:
      REGISTRY: ghcr.io
      IMAGE_NAME: ${{ format('{0}/{1}', toLower(github.repository_owner), 'lab-5-joseguadamuz') }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set image tags
        id: tags
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          BRANCH_NAME="${{ github.ref_name }}"
          
          # Normalize branch name for Docker tag (lowercase, replace invalid chars with -)
          SAFE_BRANCH=$(echo "$BRANCH_NAME" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9._-]/-/g')
          
          # Set tags
          echo "branch_tag=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${SAFE_BRANCH}" >> $GITHUB_OUTPUT
          echo "sha_tag=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:sha-${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "latest_tag=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest" >> $GITHUB_OUTPUT
          
          echo "Branch tag: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${SAFE_BRANCH}"
          echo "SHA tag: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:sha-${SHORT_SHA}"

      - name: Build Docker image
        run: |
          docker build \
            -t ${{ steps.tags.outputs.branch_tag }} \
            -t ${{ steps.tags.outputs.sha_tag }} \
            .
          
          # Tag as latest if on main branch
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            docker tag ${{ steps.tags.outputs.branch_tag }} ${{ steps.tags.outputs.latest_tag }}
            echo "Tagged as latest"
          fi

      - name: Push Docker image
        if: github.event_name != 'pull_request'
        run: |
          docker push ${{ steps.tags.outputs.branch_tag }}
          docker push ${{ steps.tags.outputs.sha_tag }}
          
          # Push latest if on main branch
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            docker push ${{ steps.tags.outputs.latest_tag }}
          fi

      - name: Install Grype
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh \
            | sh -s -- -b /usr/local/bin

      - name: Grype scan - Table output (non-blocking)
        run: |
          grype ${{ steps.tags.outputs.branch_tag }} -o table || true

      - name: Grype scan - SARIF output (non-blocking)
        run: |
          grype ${{ steps.tags.outputs.branch_tag }} -o sarif > grype.sarif || true

      - name: Upload SARIF to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: grype.sarif

      - name: Grype severity gate (fail on CRITICAL)
        run: |
          grype ${{ steps.tags.outputs.branch_tag }} --fail-on critical -o json > /dev/null

      - name: Success summary
        if: success()
        run: |
          echo "ğŸ‰ Build, Scan, and Push completed successfully!"
          echo ""
          echo "ğŸ“¦ Images pushed to GitHub Container Registry:"
          echo "  - ${{ steps.tags.outputs.branch_tag }}"
          echo "  - ${{ steps.tags.outputs.sha_tag }}"
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "  - ${{ steps.tags.outputs.latest_tag }}"
          fi
          echo ""
          echo "ğŸ”— View packages: https://github.com/${{ github.repository }}/pkgs/container/lab-5-joseguadamuz"
          echo ""
          echo "ğŸ” To pull this image:"
          echo "  docker pull ${{ steps.tags.outputs.branch_tag }}"
